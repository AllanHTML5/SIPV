{% extends "base.html" %}
{% load static %}

{% block title %}Detalle Orden {{ venta.numero }}{% endblock %}

{% block content %}

<!-- MODAL ELIMINAR -->
<div x-data="{ open:false, eliminarId:null }" 
     @open-modal.window="open=true; eliminarId=$event.detail.id;"
     x-show="open"
     x-transition.opacity
     class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">

    <div class="bg-white rounded-2xl p-6 shadow-xl w-80" x-transition.scale>
        <h2 class="text-lg font-bold text-slate-800 mb-3">Eliminar producto</h2>
        <p class="text-slate-600 text-sm mb-4">
            ¬øSeguro que deseas quitar este producto de la orden?
        </p>

        <div class="flex justify-end gap-3">
            <button @click="open=false"
                    class="px-4 py-2 rounded-lg bg-slate-200 text-slate-700">
                Cancelar
            </button>

            <button @click="$dispatch('confirm-eliminar', {id: eliminarId}); open=false;"
                    class="px-4 py-2 rounded-lg bg-red-600 text-white shadow">
                Eliminar
            </button>
        </div>
    </div>
</div>


<div x-data="POSDetalle()" class="space-y-6">

    <!-- TITULO -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-slate-800">Orden #{{ venta.numero }}</h1>

        <div class="flex items-center justify-between mb-4">
            <div class="flex gap-3">
                <a href="{% url 'ventas:dashboard' %}"
                class="inline-flex items-center gap-2 bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg shadow">
                    <i class="bi bi-arrow-left-circle text-xl"></i>
                    Volver al Dashboard
                </a>

                <a href="{% url 'ventas:crear_orden' %}"
                class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">
                    <i class="bi bi-plus-circle text-xl"></i>
                    Nueva Orden
                </a>
            </div>
        </div>

        {% if factura %}
        <div class="mt-4 flex gap-3">
            <a href="{% url 'facturas:factura_pdf' factura.id %}" target="_blank"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">üìÑ Ver Factura PDF</a>

            <a href="{% url 'facturas:factura_ticket' factura.id %}" target="_blank"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üé´ Ticket</a>
        </div>
        {% endif %}

        <span class="px-4 py-2 rounded-lg text-white font-semibold
            {% if venta.estado == 'BORRADOR' %} bg-amber-500 
            {% elif venta.estado == 'PAGADA' %} bg-emerald-600 
            {% elif venta.estado == 'CANCELADA' %} bg-red-600 
            {% endif %}">
            {{ venta.estado }}
        </span>
    </div>




    {% if venta.estado == 'BORRADOR' %}
    <div class="bg-white p-5 rounded-xl shadow border">

        <h2 class="text-xl font-semibold mb-4">Agregar producto</h2>

        <div x-data="buscarProd()" class="relative">

            <input 
                x-model="query"
                @input="debounce()"
                @keydown.enter.prevent="buscarPorEnter"
                placeholder="Buscar por nombre o c√≥digo..."
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400"
            >

            <div x-show="resultados.length > 0"
                class="absolute z-50 w-full bg-white border rounded-lg shadow-xl mt-1 overflow-hidden"
                @click.away="resultados = []"
                x-transition.opacity>

                <template x-for="item in resultados" :key="item.id">
                    <div @click="agregar(item)"
                        class="px-3 py-2 cursor-pointer hover:bg-gray-100">

                        <div class="flex justify-between">
                            <span class="font-semibold text-slate-800" x-text="item.nombre"></span>
                            <span class="font-semibold text-slate-600">
                                L <span x-text="item.precio.toFixed(2)"></span>
                            </span>
                        </div>

                        <div class="text-xs text-gray-500" x-text="'C√≥digo: ' + item.codigo"></div>
                        <div class="text-xs text-emerald-600"
                            x-text="'ISV: ' + (item.impuesto * 100).toFixed(0) + '%'"></div>
                    </div>
                </template>
            </div>

        </div>
    </div>
    {% endif %}




    <div class="space-y-4">
        <template x-for="l in lineas" :key="l.id">

            <div class="bg-white p-4 rounded-xl border shadow flex gap-4 items-start"
                 x-transition.opacity>

                <!-- INFO -->
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-slate-800" x-text="l.nombre"></h3>

                    <div class="text-xs text-slate-500 mt-1 space-y-1">
                        <p>C√≥digo: <span x-text="l.codigo"></span></p>
                        <p>Categor√≠a: <span x-text="l.categoria"></span></p>
                        <p>Proveedor: <span x-text="l.proveedor"></span></p>
                        <p>Impuesto: <span x-text="(l.impuesto*100).toFixed(0)"></span>%</p>
                        <p class="text-emerald-600 font-semibold">Stock disponible: <span x-text="l.stock"></span></p>
                    </div>

                    <!-- CANTIDAD -->
                    <div class="flex items-center gap-2 mt-3">
                        <button @click="actualizar(l.id, l.cantidad - 1)"
                            class="px-3 py-2 bg-slate-200 rounded-xl text-lg font-bold">-</button>

                        <span class="text-xl font-semibold w-10 text-center"
                              x-text="l.cantidad"></span>

                        <button @click="actualizar(l.id, l.cantidad + 1)"
                            class="px-3 py-2 bg-slate-200 rounded-xl text-lg font-bold">+</button>
                    </div>
                </div>

                <!-- SUBTOTAL -->
                <div class="text-right space-y-2">
                    <p class="text-xl font-bold text-slate-800">
                        L <span x-text="l.total.toFixed(2)"></span>
                    </p>

                    <button 
                        @click="$dispatch('open-modal', {id: l.id})"
                        class="text-red-600 hover:underline">
                        Eliminar
                    </button>
                </div>
            </div>

        </template>
    </div>





    <div class="bg-white p-5 rounded-xl shadow border text-right text-xl space-y-1">
        <p>Subtotal: <strong>L <span x-text="totales.subtotal"></span></strong></p>
        <p>Impuesto: <strong>L <span x-text="totales.impuesto"></span></strong></p>

        <p class="text-3xl mt-2">TOTAL: 
            <strong>L <span x-text="totales.total"></span></strong>
        </p>
    </div>





    {% if venta.estado == "PAGADA" %}
    <div class="bg-white p-5 rounded-xl shadow border space-y-3">

        <h2 class="text-xl font-semibold mb-2">
            <i class="bi bi-receipt"></i> Detalles del Pago
        </h2>

        <p class="text-lg"><strong>M√©todo:</strong> {{ venta.metodo_pago }}</p>

        {% if venta.metodo_pago == 'EFECTIVO' %}
        <p class="text-lg"><strong>Efectivo recibido:</strong> L {{ venta.efectivo_recibido }}</p>
        <p class="text-lg"><strong>Cambio entregado:</strong> L {{ venta.cambio_entregado }}</p>
        {% endif %}

        {% if venta.metodo_pago == 'TARJETA' or venta.metodo_pago == 'TRANSFERENCIA' %}
        <p class="text-lg"><strong>Referencia:</strong> {{ venta.referencia }}</p>
        {% endif %}

        {% if venta.metodo_pago == 'CREDITO' %}
        <p class="text-lg"><strong>Cliente al cr√©dito:</strong> {{ venta.cliente.nombre }}</p>
        {% endif %}

        <button
            @click="anularOrden"
            class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg mt-4 text-lg font-semibold">
            <i class="bi bi-x-octagon"></i> Anular Orden
        </button>
    </div>
    {% endif %}





    {% if venta.estado == "BORRADOR" %}
    <div class="bg-white p-5 rounded-xl shadow border">


        <div x-data="buscarCliente()" class="mb-6 relative">

            <label class="text-sm text-slate-600 font-semibold">Cliente</label>

            <!-- Input -->
            <input 
                x-model="query"
                @input="debounce()"
                @keydown.enter.prevent="buscarPorEnter"
                placeholder="Buscar cliente por nombre..."
                class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400"
            >

            <!-- Resultados -->
            <div x-show="resultados.length > 0"
                class="absolute z-50 w-full bg-white border rounded-lg shadow-xl mt-1 overflow-hidden"
                @click.away="resultados = []"
                x-transition.opacity>

                <template x-for="c in resultados" :key="c.id">
                    <div @click="seleccionar(c)"
                         class="px-3 py-2 cursor-pointer hover:bg-gray-100">

                        <div class="flex justify-between">
                            <span class="font-semibold text-slate-800" x-text="c.nombre"></span>
                            <span class="text-slate-500 text-xs" x-text="c.telefono || ''"></span>
                        </div>

                        <div class="text-xs text-gray-500" x-text="c.email || ''"></div>
                    </div>
                </template>
            </div>

            <!-- Tarjeta del cliente -->
            <div x-show="clienteSeleccionado"
                class="mt-4 bg-slate-100 border border-slate-300 rounded-xl p-4 space-y-1">

                <p class="text-sm"><strong>üë§ Nombre:</strong> <span x-text="clienteSeleccionado.nombre"></span></p>
                <p class="text-sm"><strong>üìû Tel√©fono:</strong> <span x-text="clienteSeleccionado.telefono || 'N/A'"></span></p>
                <p class="text-sm"><strong>‚úâ Email:</strong> <span x-text="clienteSeleccionado.email || 'N/A'"></span></p>
                <p class="text-sm"><strong>üßæ Compras:</strong> <span x-text="clienteSeleccionado.total_compras"></span></p>
            </div>

        </div>

        <!-- M√©todos de pago -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <template x-for="m in metodos" :key="m">
                <button 
                    @click="metodo = m"
                    :class="metodo===m ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                    class="py-2 rounded-lg font-semibold">
                    <span x-text="m"></span>
                </button>
            </template>
        </div>

        <!-- EFECTIVO -->
        <div x-show="metodo==='EFECTIVO'">
            <label class="text-sm text-slate-600">Efectivo recibido</label>
            <input type="number" class="border rounded px-3 py-2 w-full"
                x-model.number="efectivo" @input="calcCambio">

            <p class="mt-2 text-lg">
                Cambio: <strong>L <span x-text="cambio"></span></strong>
            </p>
        </div>

        <!-- TARJETA / TRANSFERENCIA -->
        <div x-show="metodo==='TARJETA' || metodo==='TRANSFERENCIA'">
            <label class="text-sm text-slate-600">Referencia</label>
            <input x-model="referencia" class="border px-3 py-2 rounded w-full">
        </div>


        <!-- BOTONES -->
        <button 
            @click="completar"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg mt-6 text-lg font-semibold">
            <i class="bi bi-check2-circle"></i> Completar Orden
        </button>

        <button 
            @click="cancelarOrden"
            class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg mt-4 text-lg font-semibold">
            <i class="bi bi-x-circle"></i> Cancelar Orden
        </button>

    </div>
    {% endif %}

</div>

{% endblock %}



{% block scripts %}
{{ block.super }}

<script>
document.addEventListener("alpine:init", () => {


    Alpine.data("buscarCliente", () => ({

        query: "",
        resultados: [],
        clienteSeleccionado: null,
        timer: null,

        debounce() {
            clearTimeout(this.timer);
            this.timer = setTimeout(() => this.buscar(), 220);
        },

        async buscar() {
            if (this.query.length < 2) {
                this.resultados = [];
                return;
            }

            const res = await fetch(`/ventas/api/buscar-clientes/?q=${this.query}`);
            const data = await res.json();

            this.resultados = data.results || [];
        },

        async buscarPorEnter() {
            if (!this.query) return;

            const res = await fetch(`/ventas/api/buscar-clientes/?q=${this.query}`);
            const data = await res.json();

            if (!data.results || data.results.length === 0) return;

            if (data.results.length === 1) {
                await this.seleccionar(data.results[0]);
                return;
            }

            this.resultados = data.results;
        },

        async seleccionar(cliente) {
            this.resultados = [];
            this.query = cliente.nombre;

            // Set the client in the POS controller
            POSDetalleObj.cliente = cliente.id;

            // Get extended info
            const info = await fetch(`/ventas/api/cliente-info/${cliente.id}/`);
            const dataInfo = await info.json();

            this.clienteSeleccionado = {
                id: cliente.id,
                nombre: cliente.nombre,
                telefono: cliente.telefono,
                email: cliente.email,
                total_compras: dataInfo.total_compras || 0,
            };
        },

    }));



    Alpine.data("buscarProd", () => ({

        query: "",
        resultados: [],
        timer: null,

        debounce() {
            clearTimeout(this.timer);
            this.timer = setTimeout(() => this.buscar(), 220);
        },

        async buscar() {
            if (this.query.length < 2) {
                this.resultados = [];
                return;
            }

            const res = await fetch(`/ventas/api/buscar-productos/?q=${this.query}`);
            const data = await res.json();

            this.resultados = data.results || [];
        },

        async buscarPorEnter() {
            if (!this.query) return;

            const res = await fetch(`/ventas/api/buscar-productos/?q=${this.query}`);
            const data = await res.json();

            if (!data.results || data.results.length === 0) return;

            if (data.results.length === 1) {
                await this.agregar(data.results[0]);
                this.query = "";
                this.resultados = [];
                return;
            }

            this.resultados = data.results;
        },

        async agregar(p) {
            this.query = "";
            this.resultados = [];

            const res = await fetch(`/ventas/api/linea/agregar/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    venta_id: POSDetalleObj.ventaId,
                    producto_id: p.id,
                }),
            });

            const data = await res.json();

            if (!data.ok) {
                showToast("‚ùå " + data.error, "error");
                return;
            }

            await POSDetalleObj.cargarLineas();
            showToast("‚úî Producto agregado", "success");
        },

    }));



    
    let POSDetalleObj = null;

    Alpine.data("POSDetalle", () => ({
        ventaId: "{{ venta.id }}",
        estado: "{{ venta.estado }}",
        lineas: [],
        totales: { subtotal: "0.00", impuesto: "0.00", total: "0.00" },
        
        cliente: "", 

        metodos: ["EFECTIVO", "TARJETA", "TRANSFERENCIA", "CREDITO"],
        metodo: "EFECTIVO",
        efectivo: 0,
        referencia: "",
        cambio: 0,

        init() {
            POSDetalleObj = this;
            this.cargarLineas();

            document.addEventListener("confirm-eliminar", (e) => {
                this.eliminar(e.detail.id);
            });
        },

        async cargarLineas() {
            const res = await fetch(`/ventas/api/lineas/${this.ventaId}/`);
            const data = await res.json();

            if (!data.ok) return;

            this.lineas = data.lineas;
            this.totales = data.totales;
        },

        calcCambio() {
            const ef = parseFloat(this.efectivo) || 0;
            const total = parseFloat(this.totales.total) || 0;
            this.cambio = (ef - total).toFixed(2);
        },

        async actualizar(idLinea, nuevaCant) {
            if (this.estado !== "BORRADOR") return;

            const linea = this.lineas.find(x => x.id === idLinea);
            if (!linea) return;

            if (nuevaCant > linea.stock) {
                showToast(`‚ùå Stock insuficiente. Disponible: ${linea.stock}`, "error");
                return;
            }

            if (nuevaCant <= 0) {
                this.eliminar(idLinea);
                return;
            }

            const res = await fetch(`/ventas/api/linea/actualizar/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    linea_id: idLinea,
                    cantidad: nuevaCant,
                }),
            });

            const data = await res.json();
            if (!data.ok) {
                showToast("‚ùå " + data.error, "error");
                return;
            }

            await this.cargarLineas();
            this.calcCambio(); 
        },

        async eliminar(idLinea) {
            const res = await fetch(`/ventas/api/linea/eliminar/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ linea_id: idLinea }),
            });

            const data = await res.json();
            if (!data.ok) return;

            await this.cargarLineas();
            showToast("üóë Producto eliminado", "success");
        },

        async completar() {

            if (!this.cliente) {
                showToast("‚ùå Debe seleccionar un cliente", "error");
                return;
            }

            const payload = {
                metodo: this.metodo,
                efectivo: this.efectivo,
                referencia: this.referencia,
                cliente: this.cliente,
            };

            const res = await fetch(`/ventas/api/detalle/{{ venta.id }}/completar/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken":
                        document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify(payload),
            });

            const data = await res.json();

            if (!data.ok) {
                showToast("‚ùå " + data.error, "error");
                return;
            }

            showToast("‚úî Orden completada", "success");
            setTimeout(() => window.location.reload(), 800);
        },

        async cancelarOrden() {
            const res = await fetch(`/ventas/api/detalle/{{ venta.id }}/cancelar/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken":
                        document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            const data = await res.json();

            if (!data.ok) {
                showToast("‚ùå " + data.error, "error");
                return;
            }

            showToast("üõë Orden cancelada", "success");
            setTimeout(() => window.location.reload(), 800);
        },

        async anularOrden() {
            const res = await fetch(`/ventas/api/detalle/{{ venta.id }}/anular/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken":
                        document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            const data = await res.json();

            if (!data.ok) {
                showToast("‚ùå " + data.error, "error");
                return;
            }

            showToast("‚ö† Orden anulada", "success");
            setTimeout(() => window.location.reload(), 800);
        },

    }));

});
</script>

{% endblock %}
