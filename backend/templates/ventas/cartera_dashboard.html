{% extends "base.html" %}
{% block content %}

<h1 class="text-3xl font-bold text-slate-800 mb-6">Dashboard de Cartera</h1>

<!-- CARDS -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

    <!-- Total Cr√©dito -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow hover:shadow-md transition">
        <div class="flex justify-between">
            <p class="text-slate-600 text-sm">Cr√©dito total</p>
            <span class="text-blue-500 text-xl">üí≥</span>
        </div>
        <p class="text-4xl font-extrabold text-slate-900 mt-2">
            L {{ total|floatformat:2 }}
        </p>
        <p class="text-slate-500 text-sm mt-1">Monto total actualmente pendiente</p>
    </div>

    <!-- Clientes con deuda -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow hover:shadow-md transition">
        <div class="flex justify-between">
            <p class="text-slate-600 text-sm">Clientes con deuda</p>
            <span class="text-purple-500 text-xl">üë•</span>
        </div>
        <p class="text-4xl font-extrabold text-slate-900 mt-2">
            {{ clientes_con_deuda }}
        </p>
        <p class="text-slate-500 text-sm mt-1">Clientes con cuentas activas</p>
    </div>

    <!-- Cr√©dito diario -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow hover:shadow-md transition">
        <div class="flex justify-between">
            <p class="text-slate-600 text-sm">Cr√©dito diario</p>
            <span class="text-green-500 text-xl">üìÖ</span>
        </div>
        <p class="text-4xl font-extrabold text-slate-900 mt-2">
            L {{ credito_diario|floatformat:2 }}
        </p>
        <p class="text-slate-500 text-sm mt-1">Cr√©dito otorgado hoy</p>
    </div>

</div>

<!-- BOTONES DE ACCION -->
<div class="flex gap-4 mb-10">
    <a href="{% url 'ventas:cartera_pendientes' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg shadow transition">
        Ver Cartera Vigente
    </a>

    <a href="{% url 'ventas:cartera_vencidas' %}"
       class="bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-lg shadow transition">
        Ver Cartera Vencida
    </a>

    <a href="{% url 'ventas:cartera_dashboard' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg shadow transition">
        Ver Todo
    </a>
</div>


<!-- GRAFICOS -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

    <!-- Doughnut -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow">
        <h2 class="font-semibold text-slate-800 mb-4">Distribuci√≥n de Cartera</h2>
        <canvas id="carteraPie"></canvas>
    </div>

    <!-- Barras diario -->
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow">
        <h2 class="font-semibold text-slate-800 mb-4">Cr√©dito Diario (√∫ltimos 7 d√≠as)</h2>
        <canvas id="carteraBar"></canvas>
    </div>

</div>

<!-- CREDITOS RECIENTES -->
<h2 class="text-2xl font-bold text-slate-800 mb-4">Cr√©ditos Recientes</h2>

<div class="bg-white border border-slate-200 rounded-xl shadow p-4 max-h-80 overflow-y-auto">

    <table class="min-w-full text-left">
        <thead class="border-b border-slate-200 text-slate-700">
            <tr>
                <th class="py-3 px-2">Cliente</th>
                <th class="py-3 px-2">Venta</th>
                <th class="py-3 px-2">Monto</th>
                <th class="py-3 px-2">Saldo</th>
                <th class="py-3 px-2">Creado</th>
                <th class="py-3 px-2"></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">

            {% for c in recientes %}
            <tr class="hover:bg-slate-50 transition">
                <td class="py-3 px-2">
    <a href="{% url 'ventas:detalle_credito_cliente' c.cliente.id %}"
       class="text-blue-600 hover:text-blue-800 hover:underline font-medium">
        {{ c.cliente.nombre }}
    </a>
</td>

                <td class="py-3 px-2">#{{ c.venta.numero }}</td>
                <td class="py-3 px-2 font-semibold">L {{ c.monto_total }}</td>
                <td class="py-3 px-2 text-blue-700 font-semibold">L {{ c.saldo_pendiente }}</td>
                <td class="py-3 px-2 text-slate-500">{{ c.creado|date:"d/m/Y" }}</td>
                <td class="py-3 px-2 text-right">
                    <a href="{% url 'ventas:cartera_detalle' c.id %}"
                       class="text-blue-600 hover:underline">Ver</a>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center py-4 text-slate-500">No hay cr√©ditos recientes.</td></tr>
            {% endfor %}

        </tbody>
    </table>

</div>


<!-- CHART JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
new Chart(document.getElementById('carteraPie'), {
    type: 'doughnut',
    data: {
        labels: ['Vigente', 'Vencida'],
        datasets: [{
            data: [{{ vigente_total }}, {{ vencida_total }}],
            backgroundColor: ['#22c55e', '#ef4444'],
        }]
    }
});

new Chart(document.getElementById('carteraBar'), {
    type: 'bar',
    data: {
        labels: {{ dias_labels|safe }},
        datasets: [{
            label: 'Cr√©dito Diario',
            data: {{ dias_valores|safe }},
            backgroundColor: '#3b82f6'
        }]
    },
});
</script>

{% endblock %}
