<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}SIPV - Inventario{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  {% csrf_token %}
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>


  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- HTMX + CSRF -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>
    document.addEventListener('htmx:configRequest', (e) => {
      const csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
      if (csrf) e.detail.headers['X-CSRFToken'] = csrf;
    });
  </script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Modal global -->
  <div id="modal" class="hidden fixed inset-0 z-[100] bg-black/40 p-4 overflow-y-auto"></div>

  <script>
    document.addEventListener('htmx:afterSwap', (e) => {
      if (e.detail.target.id === 'modal') {
        document.getElementById('modal').classList.remove('hidden');
      }
    });

    document.addEventListener('click', (e) => {
      const modal = document.getElementById('modal');
      if (e.target === modal)
        modal.classList.add('hidden');
    });

    document.addEventListener('close-modal', () => {
      document.getElementById('modal').classList.add('hidden');
    });
  </script>

  {% block head %}{% endblock %}
</head>

<body class="bg-slate-50 text-slate-900">

{% if request.user.is_authenticated %}
<nav class="bg-white border-b border-slate-200 shadow-sm" x-data="{ open:false }">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">

    <!-- Logo -->
    <a href="/" class="flex items-center gap-2 font-semibold text-slate-800 text-lg hover:opacity-80">
      <i class="bi bi-box-seam-fill text-indigo-700"></i>
      SIPV
    </a>

    <!-- Botón hamburguesa (solo móvil) -->
    <button @click="open=!open" class="md:hidden text-2xl text-slate-700">
      <i class="bi" :class="open ? 'bi-x-lg' : 'bi-list'"></i>
    </button>

    <!-- Links desktop -->
    <div class="hidden md:flex items-center gap-6 text-sm">

      {% if puede_inventario %}
      <a href="{% url 'inventario:dashboard' %}" class="flex items-center gap-1 hover:text-indigo-600 transition">
        <i class="bi bi-archive"></i> Inventario
      </a>
      {% endif %}

      {% if puede_compras %}
      <a href="{% url 'compras:dashboard' %}" class="flex items-center gap-1 hover:text-indigo-600 transition">
        <i class="bi bi-cart-check"></i> Compras
      </a>
      {% endif %}

      {% if puede_ventas %}
      <a href="{% url 'ventas:dashboard' %}" class="flex items-center gap-1 hover:text-indigo-600 transition">
        <i class="bi bi-cart-check"></i> Ventas
      </a>
      {% endif %}

      {% if puede_facturas %}
      <a href="{% url 'facturas:dashboard' %}" class="flex items-center gap-1 hover:text-indigo-600 transition">
        <i class="bi bi-receipt-cutoff"></i> Facturas
      </a>
      {% endif %}

      {% if puede_maestros %}
      <a href="/maestros/dashboard/" class="flex items-center gap-1 hover:text-indigo-600 transition">
        <i class="bi bi-collection"></i> Maestros
      </a>
      {% endif %}

      <!-- Dropdown Desktop -->
      <div x-data="{ userOpen:false }" class="relative">
        <button @click="userOpen=!userOpen" class="flex items-center gap-2 hover:text-indigo-600 transition">
          <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center">
            {{ request.user.username|first|upper }}
          </div>
          <span>{{ request.user.get_full_name|default:request.user.username }}</span>
          <i class="bi bi-chevron-down text-xs"></i>
        </button>

        <div
          x-show="userOpen"
          @click.away="userOpen=false"
          x-transition
          class="absolute right-0 mt-2 w-40 bg-white border border-slate-200 rounded-lg shadow-lg py-1 z-50">

          <div class="px-4 py-2 text-xs text-slate-500">
            Sesión
          </div>

          <a href="/accounts/logout/"
             class="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 transition">
            <i class="bi bi-box-arrow-right"></i> Salir
          </a>

        </div>
      </div>
    </div>
  </div>

  <!-- MENÚ MÓVIL -->
  <div
    x-show="open"
    x-transition
    class="md:hidden bg-white border-t border-slate-200 px-4 py-3 space-y-3 text-sm">

    {% if puede_inventario %}
    <a href="{% url 'inventario:dashboard' %}" class="block flex items-center gap-2 hover:text-indigo-600">
      <i class="bi bi-archive"></i> Inventario
    </a>
    {% endif %}

    {% if puede_compras %}
    <a href="{% url 'compras:dashboard' %}" class="block flex items-center gap-2 hover:text-indigo-600">
      <i class="bi bi-cart-check"></i> Compras
    </a>
    {% endif %}

    {% if puede_ventas %}
    <a href="{% url 'ventas:dashboard' %}" class="block flex items-center gap-2 hover:text-indigo-600">
      <i class="bi bi-cart-check"></i> Ventas
    </a>
    {% endif %}

    {% if puede_facturas %}
    <a href="{% url 'facturas:dashboard' %}" class="block flex items-center gap-2 hover:text-indigo-600">
      <i class="bi bi-receipt-cutoff"></i> Facturas
    </a>
    {% endif %}

    {% if puede_maestros %}
    <a href="/maestros/dashboard/" class="block flex items-center gap-2 hover:text-indigo-600">
      <i class="bi bi-collection"></i> Maestros
    </a>
    {% endif %}

    <!-- User mobile -->
    <div class="border-t pt-3">
      <a href="/accounts/logout/" class="flex items-center gap-2 text-red-600 hover:bg-red-50 px-2 py-2 rounded">
        <i class="bi bi-box-arrow-right"></i> Salir
      </a>
    </div>

  </div>
</nav>

{% endif %}

<main class="max-w-7xl mx-auto p-4">
  {% block content %}{% endblock %}
</main>

<!-- TOASTER -->
<div id="toast"
     class="fixed bottom-4 right-4 hidden px-4 py-3 rounded-lg shadow-lg text-white text-sm font-semibold">
</div>

<script>
function showToast(msg, type="success") {
  const t = document.getElementById("toast");

  t.className =
    `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-semibold 
     ${type === "error" ? "bg-red-600" : "bg-emerald-600"}`;

  t.textContent = msg;
  t.classList.remove("hidden");

  setTimeout(() => t.classList.add("hidden"), 2800);
}

document.body.addEventListener("htmx:afterRequest", (e) => {
  const m = e.detail.xhr.getResponseHeader("X-Toast");
  if (m) showToast(m);
});
</script>

{% if messages %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  {% for message in messages %}
    showToast("{{ message|escapejs }}");
  {% endfor %}
});
</script>
{% endif %}

{% block scripts %}{% endblock %}
</body>
</html>
