{% extends "base.html" %}
{% load static %}

{% block title %}Compra #{{ compra.id }}{% endblock %}

{% block content %}


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function toastOK(msg) {
    Swal.fire({
        toast: true,
        position: "top-end",
        icon: "success",
        title: msg,
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
    });
}

function toastError(msg) {
    Swal.fire({
        toast: true,
        position: "top-end",
        icon: "error",
        title: msg,
        showConfirmButton: false,
        timer: 2500,
        timerProgressBar: true
    });
}
</script>

<div x-data="{ open:false, eliminarId:null }"
     @open-modal.window="open=true; eliminarId=$event.detail.id"
     x-show="open"
     x-transition.opacity
     class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">

    <div class="bg-white rounded-2xl p-6 shadow-xl w-80" x-transition.scale>
        <h2 class="text-lg font-bold mb-3 text-slate-800">Eliminar producto</h2>
        <p class="text-slate-600 text-sm mb-4">
            Â¿Seguro que deseas quitar este producto de la compra?
        </p>

        <div class="flex justify-end gap-3">
            <button @click="open=false"
                    class="px-4 py-2 rounded-lg bg-slate-200 text-slate-700">Cancelar</button>

            <button @click="$dispatch('confirm-eliminar', {id: eliminarId}); open=false;"
                    class="px-4 py-2 rounded-lg bg-red-600 text-white shadow">Eliminar</button>
        </div>
    </div>
</div>

<div x-data="POSCompras()" class="space-y-6">

    <!-- TÃTULO Y ACCIONES -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-slate-800">Compra #{{ compra.id }}</h1>

        <div class="flex gap-3">
            <a href="{% url 'compras:dashboard' %}"
                class="inline-flex items-center gap-2 bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg shadow">
                <i class="bi bi-arrow-left-circle text-xl"></i> Volver
            </a>

            <a href="{% url 'compras:crear_compra_borrador' %}"
                class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">
                <i class="bi bi-plus-circle text-xl"></i> Nueva Compra
            </a>
        </div>
    </div>

    <!-- ESTADO -->
    <span class="px-4 py-2 rounded-lg text-white font-semibold
        {% if compra.estado == 'BORRADOR' %} bg-amber-500
        {% elif compra.estado == 'CONFIRMADA' %} bg-emerald-600
        {% elif compra.estado == 'ANULADA' %} bg-red-600
        {% endif %}">
        {{ compra.estado }}
    </span>


    {% if compra.estado == "CONFIRMADA" %}
    <div class="bg-white p-5 rounded-xl shadow border space-y-4">
        <h2 class="text-xl font-semibold flex items-center gap-2">
            <i class="bi bi-receipt"></i> Documentos
        </h2>

        {% if factura %}
            <a href="/facturas/{{ factura.id }}/pdf/" target="_blank"
               class="block px-4 py-3 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-center font-semibold">
                ðŸ“„ Ver Factura (PDF)
            </a>

            <a href="/facturas/{{ factura.id }}/ticket/" target="_blank"
               class="block px-4 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-center font-semibold">
                ðŸ§¾ Ver Ticket
            </a>
        {% else %}
            <p class="text-slate-600 text-sm italic">No se encontrÃ³ factura generada.</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- PROVEEDOR -->
    <div class="bg-white p-5 rounded-xl shadow border">
        <h2 class="text-xl font-semibold mb-4">Proveedor</h2>

        <select x-model="proveedor"
                class="border px-3 py-2 rounded w-full"
                :disabled="estado !== 'BORRADOR'">
            <option value="">Seleccione proveedorâ€¦</option>
            {% for p in proveedores %}
            <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
        </select>
    </div>


    <template x-if="estado !== 'ANULADA'">
        <div class="bg-white p-5 rounded-xl shadow border">
            <h2 class="text-xl font-semibold mb-4">Agregar producto</h2>

            <div x-data="buscarProd()" class="relative">
                <input x-model="query"
                       @input="debounce()"
                       @keydown.enter.prevent="buscarPorEnter"
                       placeholder="Buscar por nombre o cÃ³digo..."
                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">

                <div x-show="resultados.length > 0"
                     @click.away="resultados=[]"
                     class="absolute w-full z-50 bg-white border rounded-lg shadow-xl mt-1 overflow-hidden">

                    <template x-for="item in resultados" :key="item.id">
                        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
                             @click="agregar(item)">

                            <div class="flex justify-between">
                                <span class="font-semibold text-slate-800" x-text="item.nombre"></span>
                                <span class="font-semibold text-slate-600">
                                    L <span x-text="item.costo.toFixed(2)"></span>
                                </span>
                            </div>

                            <div class="text-xs text-gray-500" x-text="'CÃ³digo: '+item.codigo"></div>
                            <div class="text-xs text-emerald-600" x-text="'Stock: '+item.stock"></div>
                        </div>
                    </template>

                </div>
            </div>
        </div>
    </template>



    <div class="space-y-4">
        <template x-for="l in lineas" :key="l.id">
            <div class="bg-white p-4 rounded-xl border shadow flex gap-4 items-start">
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-slate-800" x-text="l.producto"></h3>

                    <div class="text-xs text-slate-500 mt-1 space-y-1">
                        <p>CategorÃ­a: <span x-text="l.categoria"></span></p>
                        <p class="text-emerald-600 font-semibold">
                            Costo: L <span x-text="l.costo.toFixed(2)"></span>
                        </p>
                        <p class="text-blue-600 font-semibold">
                            Stock actual: <span x-text="l.stock"></span>
                        </p>
                    </div>

                    <template x-if="estado === 'BORRADOR'">
                        <div class="flex items-center gap-2 mt-3">
                            <button @click="actualizar(l.id, l.cantidad-1)"
                                    class="px-3 py-2 bg-slate-200 rounded-xl">-</button>
                            <span class="text-xl font-semibold w-10 text-center" x-text="l.cantidad"></span>
                            <button @click="actualizar(l.id, l.cantidad+1)"
                                    class="px-3 py-2 bg-slate-200 rounded-xl">+</button>
                        </div>
                    </template>
                </div>

                <div class="text-right space-y-2">
                    <p class="text-xl font-bold text-slate-800">
                        L <span x-text="l.total.toFixed(2)"></span>
                    </p>

                    <template x-if="estado === 'BORRADOR'">
                        <button @click="$dispatch('open-modal',{id:l.id})"
                                class="text-red-600 hover:underline">Eliminar</button>
                    </template>
                </div>
            </div>
        </template>
    </div>


    <div class="bg-white p-5 rounded-xl shadow border text-right text-xl space-y-1">
        <p>Subtotal: <strong>L <span x-text="totales.subtotal"></span></strong></p>
        <p>Impuesto: <strong>L <span x-text="totales.impuesto"></span></strong></p>

        <p class="text-3xl mt-2">
            TOTAL: <strong>L <span x-text="totales.total"></span></strong>
        </p>
    </div>
            <template x-if="estado === 'BORRADOR' || estado === 'CONFIRMADA'">
                <button @click="preguntarAnular"
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg text-lg font-semibold">
                     âœ– Anular Compra
                </button>
            </template>

    <template x-if="estado === 'BORRADOR'">
        <div class="bg-white p-5 rounded-xl shadow border space-y-5">

            <h2 class="text-xl font-semibold"><i class="bi bi-credit-card"></i> Pago</h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <template x-for="m in metodos" :key="m">
                    <button @click="metodo=m"
                            :class="metodo===m ? 'bg-emerald-600 text-white' : 'bg-slate-200'"
                            class="py-2 rounded-lg font-semibold">
                        <span x-text="m"></span>
                    </button>
                </template>
            </div>

            <div x-show="metodo === 'EFECTIVO'">
                <label class="text-sm text-slate-600">Efectivo recibido</label>
                <input type="number" class="border rounded px-3 py-2 w-full"
                       x-model.number="efectivo" @input="calcCambio">
                <p class="mt-2 text-lg">
                    Cambio: <strong>L <span x-text="cambio"></span></strong>
                </p>
            </div>

            <div x-show="metodo === 'TRANSFERENCIA' || metodo === 'TARJETA'">
                <label class="text-sm text-slate-600">Referencia</label>
                <input x-model="referencia" class="border px-3 py-2 rounded w-full">
            </div>

            <div x-show="metodo === 'CREDITO'">
                <p class="text-sm text-slate-600">
                    Esta compra quedarÃ¡ a crÃ©dito con el proveedor seleccionado.
                </p>
            </div>

            <button @click="confirmar"
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg text-lg font-semibold">
                âœ” Confirmar Compra
            </button>


        </div>
    </template>

</div>

{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
document.addEventListener("alpine:init", () => {


Alpine.data("buscarProd", () => ({
    query:"", resultados:[], timer:null,

    debounce(){
        clearTimeout(this.timer);
        this.timer = setTimeout(()=>this.buscar(),200);
    },

    async buscar(){
        if(this.query.length < 2){
            this.resultados=[];
            return;
        }
        let r = await fetch(`/compras/api/buscar-productos/?q=${this.query}`);
        let d = await r.json();
        this.resultados = d.results || [];
    },

    async buscarPorEnter(){
        if(!this.query) return;

        let r = await fetch(`/compras/api/buscar-productos/?q=${this.query}`);
        let d = await r.json();

        if(d.results.length === 1){
            await this.agregar(d.results[0]);
            this.query="";
            this.resultados=[];
            return;
        }

        this.resultados = d.results;
    },

    async agregar(p){
        this.query="";
        this.resultados=[];

        let res = await fetch(`/compras/api/agregar-linea/`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body:JSON.stringify({
                compra_id: POSCompraObj.compraId,
                producto_id: p.id
            })
        });

        let d = await res.json();

        if(!d.ok){
            toastError("No se pudo agregar");
            return;
        }

        await POSCompraObj.cargarLineas();
    }
}));


let POSCompraObj = null;

Alpine.data("POSCompras", () => ({

    compraId:"{{ compra.id }}",
    estado:"{{ compra.estado }}",
    proveedor: Number("{{ compra.proveedor.id|default_if_none:'' }}") || "",

    lineas:[],
    totales:{subtotal:"0.00", impuesto:"0.00", total:"0.00"},

    metodos:["EFECTIVO","TARJETA","TRANSFERENCIA","CREDITO"],
    metodo:"EFECTIVO",
    efectivo:0,
    referencia:"",
    cambio:0,

    init(){
        POSCompraObj = this;
        this.cargarLineas();

        document.addEventListener("confirm-eliminar", e=>{
            this.eliminar(e.detail.id);
        });
    },

    async cargarLineas(){
        let r = await fetch(`/compras/api/lineas/${this.compraId}/`);
        let d = await r.json();
        if(!d.ok) return;

        this.lineas = d.lineas;
        this.totales = d.totales;
        this.calcCambio();
    },

    async actualizar(id,cant){
        if(this.estado !== "BORRADOR") return;

        if(cant <= 0){
            this.eliminar(id);
            return;
        }

        await fetch(`/compras/api/actualizar-linea/`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body:JSON.stringify({linea_id:id, cantidad:cant})
        });

        await this.cargarLineas();
    },

    async eliminar(id){
        await fetch(`/compras/api/eliminar-linea/`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body:JSON.stringify({linea_id:id})
        });

        await this.cargarLineas();
    },

    calcCambio(){
        const ef = parseFloat(this.efectivo)||0;
        const tot = parseFloat(this.totales.total)||0;
        this.cambio = (ef - tot).toFixed(2);
    },

    async confirmar(){
        if(this.proveedor === ""){
            toastError("Seleccione un proveedor");
            return;
        }

        let payload = {
            proveedor: this.proveedor,
            metodo: this.metodo,
            efectivo: this.efectivo,
            referencia: this.referencia
        };

        let r = await fetch(`/compras/api/completar/{{ compra.id }}/`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body:JSON.stringify(payload)
        });

        let d = await r.json();

        if(!d.ok){
            toastError("Error al confirmar");
            return;
        }

        toastOK("Compra confirmada");
        setTimeout(()=>location.reload(),800);
    },


    async preguntarAnular(){
        const res = await Swal.fire({
            title: "Â¿Anular compra?",
            text: "Esta acciÃ³n no se puede revertir.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc2626",
            cancelButtonColor: "#6b7280",
            confirmButtonText: "SÃ­, anular",
            cancelButtonText: "Cancelar"
        });

        if(res.isConfirmed){
            this.anular();
        }
    },

    async anular(){
        let r = await fetch(`/compras/api/anular/{{ compra.id }}/`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value
            }
        });

        let d = await r.json();

        if(!d.ok){
            toastError(d.error || "No se pudo anular");
            return;
        }

        toastOK("Compra anulada");
        setTimeout(()=>location.reload(),800);
    }

}));

});
</script>

{% endblock %}
